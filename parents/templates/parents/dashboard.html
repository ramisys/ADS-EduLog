{% extends 'base.html' %}
{% load static %}

{% block title %}Parent Dashboard - EduLog{% endblock %}

{% block extra_css %}
<style>
    .card-custom {
        border: 1px solid #e5e7eb;
        border-radius: 1rem;
        padding: 1.5rem;
    }
    .badge-custom {
        font-weight: 500;
        font-size: 0.8rem;
        padding: 0.35em 0.7em;
        border-radius: 0.375rem;
    }
    .bg-green-light {
        background-color: #d1fae5;
        color: #047857;
    }
    .bg-yellow-light {
        background-color: #fef3c7;
        color: #92400e;
    }
    .bg-blue-light {
        background-color: #dbeafe;
        color: #1e40af;
    }
    .bg-red-light {
        background-color: #fee2e2;
        color: #b91c1c;
    }
    /* For icon containers */
    .icon-bg {
        border-radius: 0.75rem;
        padding: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .icon-yellow {
        background-color: #fef3c7;
        color: #ca8a04;
    }
    .icon-green {
        background-color: #d1fae5;
        color: #16a34a;
    }
    .icon-blue {
        background-color: #dbeafe;
        color: #2563eb;
    }
    .icon-red {
        background-color: #fee2e2;
        color: #dc2626;
    }
    /* Progress bar custom height */
    .progress {
        height: 0.5rem;
    }
    /* Small circle for legend */
    .legend-circle {
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    .legend-excellent { background-color: #10b981; }
    .legend-good { background-color: #3b82f6; }
    .legend-average { background-color: #f59e0b; }
    .legend-needs { background-color: #ef4444; }
    .legend-count {
        font-weight: 600;
    }
    .legend-count.legend-excellent { color: #10b981; }
    .legend-count.legend-good { color: #3b82f6; }
    .legend-count.legend-average { color: #f59e0b; }
    .legend-count.legend-needs { color: #ef4444; }
    .progress-overall {
        height: 0.4rem;
        background-color: #e2e8f0;
        border-radius: 999px;
    }
    .progress-overall .progress-bar {
        background-color: #0f172a;
        border-radius: 999px;
        transition: width 0.4s ease;
    }
    .progress-highlight {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #16a34a;
        font-weight: 600;
    }
    .progress-note {
        background-color: #dcfce7;
        color: #15803d;
        border: 1px solid #bbf7d0;
    }
</style>
{% endblock %}


{% block content %}
<div class="dashboard-container">
    <div class="container">
        <!-- Child Selector Card -->
        <div class="card card-custom mb-5">
          <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
            <div>
              <h3 class="text-primary mb-1">Monitoring</h3>
              <p class="text-secondary small mb-0">
                {% if children %}
                  Select one of your children to view their progress
                {% else %}
                  No linked student profiles found for your account.
                {% endif %}
              </p>
            </div>
            <select class="form-select rounded-pill w-100 w-md-auto" id="dashboardChildSelector" aria-label="Select Child" {% if not children %}disabled{% endif %}>
              {% if children %}
                {% for child in children %}
                  <option value="{{ child.id }}"
                          {% if selected_child_stats and selected_child_stats.child.id == child.id or not selected_child_stats and forloop.first %}selected{% endif %}>
                    {{ child.user.get_full_name }} - {{ child.year_level }}{% if child.section %} ({{ child.section.name }}){% endif %}
                  </option>
                {% endfor %}
              {% else %}
                <option>No children available</option>
              {% endif %}
            </select>
          </div>
        </div>
    
        <!-- Quick Stats Grid -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4 mb-5">
          <div class="col">
            <div class="card card-custom h-100">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-secondary small mb-1">Average Grade</p>
                  <p class="text-primary h5 mb-2">
                    {% if has_grade_data %}{{ overall_avg }}{% else %}N/A{% endif %}
                  </p>
                  {% if has_grade_data %}
                    {% if overall_avg >= 90 %}
                      <span class="badge bg-green-light">Excellent</span>
                    {% elif overall_avg >= 80 %}
                      <span class="badge bg-blue-light">Above Average</span>
                    {% elif overall_avg >= 70 %}
                      <span class="badge bg-yellow-light">Needs Improvement</span>
                    {% else %}
                      <span class="badge bg-red-light">At Risk</span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-yellow-light">No grades yet</span>
                  {% endif %}
                </div>
                <div class="icon-bg icon-yellow">
                  <i class="bi bi-award fs-4"></i>
                </div>
              </div>
            </div>
          </div>
    
          <div class="col">
            <div class="card card-custom h-100">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-secondary small mb-1">Attendance Rate</p>
                  <p class="text-primary h5 mb-2">
                    {% if has_attendance_data %}{{ overall_attendance_percentage }}%{% else %}N/A{% endif %}
                  </p>
                  {% if has_attendance_data %}
                    {% if overall_attendance_percentage >= 95 %}
                      <span class="badge bg-green-light">Excellent</span>
                    {% elif overall_attendance_percentage >= 85 %}
                      <span class="badge bg-blue-light">Good</span>
                    {% elif overall_attendance_percentage >= 75 %}
                      <span class="badge bg-yellow-light">Monitor</span>
                    {% else %}
                      <span class="badge bg-red-light">Low Attendance</span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-yellow-light">No records yet</span>
                  {% endif %}
                </div>
                <div class="icon-bg icon-green">
                  <i class="bi bi-check-circle-fill fs-4"></i>
                </div>
              </div>
            </div>
          </div>
    
          <div class="col">
            <div class="card card-custom h-100">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-secondary small mb-1">Children Tracked</p>
                  <p class="text-primary h5 mb-2">{{ children|length }}</p>
                  {% if children %}
                    <span class="badge bg-blue-light">Active profiles</span>
                  {% else %}
                    <span class="badge bg-yellow-light">No linked students</span>
                  {% endif %}
                </div>
                <div class="icon-bg icon-blue">
                  <i class="bi bi-bar-chart-line-fill fs-4"></i>
                </div>
              </div>
            </div>
          </div>
    
          <div class="col">
            <div class="card card-custom h-100">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-secondary small mb-1">New Alerts</p>
                  <p class="text-primary h5 mb-2">{{ alerts_count }}</p>
                  {% if alerts_count %}
                    <span class="badge bg-yellow-light">Requires attention</span>
                  {% else %}
                    <span class="badge bg-green-light">All caught up</span>
                  {% endif %}
                </div>
                <div class="icon-bg icon-red">
                  <i class="bi bi-exclamation-circle-fill fs-4"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
    
        <!-- Charts Grid -->
        <div class="row g-4 mb-5">
          <div class="col-lg-6">
            <div class="card card-custom h-100">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h3 class="text-primary mb-1">Attendance Trend</h3>
                  <p class="text-secondary small mb-0">6-month overview</p>
                </div>
                <i class="bi bi-calendar3 text-muted fs-5"></i>
              </div>
              <div class="border rounded p-3">
                <canvas id="attendanceTrendChart" height="250"></canvas>
              </div>
            </div>
          </div>
    
          <div class="col-lg-6">
            <div class="card card-custom h-100">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h3 class="text-primary mb-1">Academic Performance</h3>
                  <p class="text-secondary small mb-0">Average grade per subject</p>
                </div>
                <i class="bi bi-graph-up-arrow text-muted fs-5"></i>
              </div>
              <div class="border rounded p-3">
                <canvas id="academicPerformanceChart" height="250"></canvas>
              </div>
            </div>
          </div>
        </div>
    
        <!-- Performance Distribution and Skills -->
        <div class="row g-4">
          <div class="col-lg-4">
            <div class="card card-custom h-100">
              <div class="mb-4">
                <h3 class="text-primary mb-1">Performance Distribution</h3>
                <p class="text-secondary small mb-0">Grade breakdown</p>
              </div>
              <div class="border rounded p-3 mb-3">
                <canvas id="gradeDistributionChart" height="200"></canvas>
              </div>
              <!-- Legend -->
              <div class="d-flex flex-column gap-2">
                {% for bucket in grade_buckets %}
                  <div class="d-flex justify-content-between text-secondary small">
                    <div class="d-flex align-items-center">
                      <span class="legend-circle {{ bucket.css_class }}"></span>
                      {{ bucket.label }}
                    </div>
                    <span class="legend-count {{ bucket.css_class }}">{{ bucket.count }}</span>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
    
          <div class="col-lg-8">
            <div class="card card-custom h-100">
              <div class="mb-4">
                <h3 class="text-primary mb-1">Subject Performance Overview</h3>
                <p class="text-secondary small mb-0">Radar chart showing strengths and areas for improvement</p>
              </div>
              <div class="row g-4">
                <div class="col-md-6">
                  <div class="border rounded p-3">
                    <canvas id="subjectRadarChart" height="250"></canvas>
                  </div>
                </div>
                <div class="col-md-6 d-flex flex-column justify-content-center">
                  <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center small text-secondary fw-semibold mb-2">
                      <span>Overall Progress</span>
                      <span class="text-primary">{{ progress_display }}%</span>
                    </div>
                    <div class="progress progress-overall" role="progressbar"
                         aria-valuenow="{{ progress_display }}"
                         aria-valuemin="0" aria-valuemax="100">
                      <div class="progress-bar"
                           data-progress="{{ progress_width }}"></div>
                    </div>
                  </div>
                  <div class="small">
                    <div class="progress-highlight mb-3">
                      <i class="bi bi-bullseye fs-5"></i>
                      <span>{{ progress_status_text }}</span>
                    </div>
                    <div class="p-3 rounded progress-note">
                      <p class="mb-0">{{ progress_alert_text }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Handle child selector change - store selected child ID
    var dashboardChildSelector = document.getElementById('dashboardChildSelector');
    if (dashboardChildSelector) {
      // Store initial selected child ID
      var initialChildId = dashboardChildSelector.value;
      if (initialChildId) {
        sessionStorage.setItem('selectedChildId', initialChildId);
      }

      dashboardChildSelector.addEventListener('change', function () {
        var childId = this.value;
        sessionStorage.setItem('selectedChildId', childId);
        // Reload page to update dashboard stats for selected child
        window.location.href = window.location.pathname + '?child_id=' + childId;
      });
    }

    // Update all links to child-subjects to include selected child ID
    var selectedChildId = sessionStorage.getItem('selectedChildId') || (dashboardChildSelector ? dashboardChildSelector.value : null);
    if (selectedChildId) {
      document.querySelectorAll('a[href*="child-subjects"]').forEach(function(link) {
        var href = link.getAttribute('href');
        if (href && !href.includes('child_id=')) {
          var separator = href.includes('?') ? '&' : '?';
          link.setAttribute('href', href + separator + 'child_id=' + selectedChildId);
        }
      });
    }

    // Progress bars
    document.querySelectorAll('[data-progress]').forEach(function (bar) {
      var value = parseFloat(bar.getAttribute('data-progress'));
      if (isNaN(value)) {
        value = 0;
      }
      bar.style.width = value + '%';
    });

    // Attendance Trend (Line)
    var attendanceLabels = JSON.parse('{{ attendance_chart_labels|escapejs }}');
    var attendanceData = JSON.parse('{{ attendance_chart_data|escapejs }}');
    var attendanceHasData = Array.isArray(attendanceData) && attendanceData.some(function (value) {
      return typeof value === 'number' && value > 0;
    });
    if (!attendanceHasData) {
      // Use empty data instead of hardcoded values
      attendanceData = [0, 0, 0, 0, 0, 0];
      // Keep the actual month labels from the view
    }
    var attendanceCtx = document.getElementById('attendanceTrendChart');
    if (attendanceCtx && Array.isArray(attendanceLabels)) {
      new Chart(attendanceCtx, {
        type: 'line',
        data: {
          labels: attendanceLabels,
          datasets: [{
            label: 'Attendance Rate (%)',
            data: attendanceData,
            borderColor: '#0ea5e9',
            backgroundColor: 'rgba(14, 165, 233, 0.15)',
            tension: 0.45,
            fill: true,
            pointRadius: 5,
            pointHoverRadius: 6,
            pointBackgroundColor: '#0ea5e9',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            borderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                stepSize: 25,
                color: '#94a3b8',
                font: {
                  size: 12,
                  family: 'Inter, "Segoe UI", sans-serif'
                },
                callback: function (value) { return value; }
              },
              grid: {
                color: '#e2e8f0',
                drawBorder: false
              }
            },
            x: {
              ticks: {
                color: '#94a3b8',
                font: {
                  size: 12,
                  family: 'Inter, "Segoe UI", sans-serif'
                }
              },
              grid: {
                display: false,
                drawBorder: false
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    // Academic Performance (Bar) & Subject Radar share same data
    var subjectLabels = JSON.parse('{{ subject_chart_labels|escapejs }}');
    var subjectData = JSON.parse('{{ subject_chart_data|escapejs }}');
    var subjectPrevData = JSON.parse('{{ subject_prev_term_data|escapejs }}');
    var subjectCurrentData = JSON.parse('{{ subject_current_term_data|escapejs }}');
    var subjectPrevLabel = '{{ subject_prev_term_label|default:"Previous Term" }}';
    var subjectCurrentLabel = '{{ subject_current_term_label|default:"Current Term" }}';

    var safeSubjectLabels = (Array.isArray(subjectLabels) && subjectLabels.length) ? subjectLabels : ['No Data'];
    var safeSubjectData = (Array.isArray(subjectData) && subjectData.length) ? subjectData : [0];

    function normalizeData(data, length) {
      if (!Array.isArray(data) || data.length === 0) {
        return Array(length).fill(0);
      }
      if (data.length < length) {
        return data.concat(Array(length - data.length).fill(0));
      }
      if (data.length > length) {
        return data.slice(0, length);
      }
      return data;
    }

    var safePrevData = normalizeData(subjectPrevData, safeSubjectLabels.length);
    var safeCurrentData = normalizeData(subjectCurrentData, safeSubjectLabels.length);

    var performanceHasData = safeCurrentData.some(function (value) { return value > 0; });
    // Use empty data instead of hardcoded values when no data is available
    if (!performanceHasData) {
      // Keep the actual labels from the view (which will be empty or 'No Data')
      // Keep the data as zeros
    }

    var academicCtx = document.getElementById('academicPerformanceChart');
    if (academicCtx) {
      new Chart(academicCtx, {
        type: 'bar',
        data: {
          labels: safeSubjectLabels,
          datasets: [
            {
              label: subjectPrevLabel || 'Previous Term',
              data: safePrevData,
              backgroundColor: '#cbd5f5',
              borderRadius: 10,
              barThickness: 20,
              borderSkipped: false
            },
            {
              label: subjectCurrentLabel || 'Current Term',
              data: safeCurrentData,
              backgroundColor: '#10b981',
              borderRadius: 10,
              barThickness: 20,
              borderSkipped: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              grid: {
                color: '#e2e8f0',
                drawBorder: false
              },
              ticks: {
                stepSize: 25,
                color: '#94a3b8',
                font: {
                  size: 12,
                  family: 'Inter, "Segoe UI", sans-serif'
                }
              }
            },
            x: {
              stacked: false,
              ticks: {
                color: '#1e293b',
                font: {
                  size: 12,
                  family: 'Inter, "Segoe UI", sans-serif'
                }
              },
              grid: {
                display: false,
                drawBorder: false
              }
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              align: 'start',
              labels: {
                usePointStyle: true,
                pointStyle: 'circle',
                boxWidth: 8,
                color: '#1e293b',
                font: {
                  size: 12,
                  family: 'Inter, "Segoe UI", sans-serif'
                }
              }
            }
          }
        }
      });
    }

    var radarLabels = safeSubjectLabels.slice();
    var radarData = safeSubjectData.slice();
    var radarHasData = Array.isArray(radarData) && radarData.some(function (value) { return value > 0; });
    // Use empty data instead of hardcoded values when no data is available
    if (!radarHasData || radarLabels.length < 3) {
      // Keep the actual labels from the view (which will be empty or 'No Data')
      // Keep the data as zeros
      if (radarLabels.length === 0) {
        radarLabels = ['No Data'];
        radarData = [0];
      }
    }

    var radarCtx = document.getElementById('subjectRadarChart');
    if (radarCtx) {
      new Chart(radarCtx, {
        type: 'radar',
        data: {
          labels: radarLabels,
          datasets: [{
            label: 'Subject Strength',
            data: radarData,
            backgroundColor: 'rgba(37, 99, 235, 0.2)',
            borderColor: '#2563eb',
            pointBackgroundColor: '#2563eb',
            pointBorderColor: '#ffffff',
            pointRadius: 3,
            pointHoverRadius: 4,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            r: {
              beginAtZero: true,
              suggestedMax: 100,
              angleLines: {
                color: '#e2e8f0'
              },
              grid: {
                color: '#e2e8f0'
              },
              pointLabels: {
                color: '#1e293b',
                font: {
                  size: 12,
                  family: 'Inter, "Segoe UI", sans-serif'
                }
              },
              ticks: {
                display: false
              }
            }
          }
        }
      });
    }

    // Grade Distribution (Doughnut)
    var gradeLabels = JSON.parse('{{ grade_labels_json|escapejs }}');
    var gradeColors = JSON.parse('{{ grade_colors_json|escapejs }}');
    var gradeData = JSON.parse('{{ grade_distribution_data|escapejs }}') || [0, 0, 0, 0];
    var gradeCtx = document.getElementById('gradeDistributionChart');
    if (gradeCtx) {
      var totalGrades = gradeData.reduce(function (sum, v) { return sum + v; }, 0);
      // Use actual data - if no data, show zeros (chart will be empty but visible)
      var gradeDataForChart = totalGrades > 0 ? gradeData : [0, 0, 0, 0];

      new Chart(gradeCtx, {
        type: 'doughnut',
        data: {
          labels: gradeLabels,
          datasets: [{
            data: gradeDataForChart,
            backgroundColor: gradeColors,
            borderWidth: 8,
            hoverOffset: 6,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '65%',
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  var label = context.label || '';
                  // Always show the real counts, even if we used fallback data for the chart
                  var index = context.dataIndex;
                  var value = (Array.isArray(gradeData) && gradeData[index] !== undefined) ? gradeData[index] : 0;
                  return label + ': ' + value;
                }
              }
            }
          }
        }
      });
    }
  });
</script>
{% endblock %}
