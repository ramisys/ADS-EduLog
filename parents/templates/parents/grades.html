{% extends "base.html" %}
{% block title %}Grades | EduLog{% endblock %}

{% block extra_css %}
<style>
  .card-custom {
    border: 1px solid #e5e7eb;
    border-radius: 1rem;
    padding: 1.5rem;
    transition: box-shadow 0.2s ease;
  }
  .card-custom:hover {
    box-shadow: 0 0.75rem 1.5rem rgb(0 0 0 / 0.08);
  }
  .progress {
    height: 0.45rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container py-4">
  <div class="mb-4">
    <h2 class="text-primary mb-1">Grades Overview</h2>
    <p class="text-secondary small mb-0">Detailed grades with assessment details and performance tracking.</p>
  </div>

  {% if not child %}
    <div class="alert alert-warning">
      No linked student profiles were found. Please contact the administrator to connect your account.
    </div>
  {% else %}
    {% if all_children|length > 1 %}
    <div class="card card-custom mb-4">
      <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
        <div>
          <h3 class="text-primary mb-1">Select Student</h3>
          <p class="text-secondary small mb-0">Choose which student's grades to view</p>
        </div>
        <select class="form-select rounded-pill w-100 w-md-auto" id="childSelector" aria-label="Select Child">
          {% for child_option in all_children %}
            <option value="{{ child_option.id }}"
                    {% if child.id == child_option.id %}selected{% endif %}>
              {{ child_option.user.get_full_name }} - {{ child_option.year_level }}{% if child_option.section %} ({{ child_option.section.name }}){% endif %}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>
    {% endif %}

    <!-- Grade Summary by Subject -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4">
      {% if subject_grades %}
        {% for subj_grade in subject_grades %}
          <div class="col">
            <div class="card card-custom h-100">
              <div class="d-flex justify-content-between mb-2">
                <h4 class="text-primary mb-0">{{ subj_grade.subject.name }}</h4>
                {% if subj_grade.avg_grade %}
                  {% if subj_grade.avg_grade >= 90 %}
                    <span class="badge bg-success">{{ subj_grade.avg_grade }}%</span>
                  {% elif subj_grade.avg_grade >= 75 %}
                    <span class="badge bg-warning text-dark">{{ subj_grade.avg_grade }}%</span>
                  {% else %}
                    <span class="badge bg-danger">{{ subj_grade.avg_grade }}%</span>
                  {% endif %}
                {% else %}
                  <span class="badge bg-secondary">No grades</span>
                {% endif %}
              </div>

              <div class="progress mb-2" style="height: 6px;">
                <div class="progress-bar {% if subj_grade.avg_grade and subj_grade.avg_grade >= 90 %}bg-success{% elif subj_grade.avg_grade and subj_grade.avg_grade >= 75 %}bg-warning{% else %}bg-danger{% endif %}" 
                     data-width="{{ subj_grade.avg_grade|default:0 }}"></div>
              </div>

              <p class="text-muted small mb-0">
                {% if subj_grade.avg_grade %}
                  Current average
                {% else %}
                  No grades recorded yet
                {% endif %}
              </p>
              {% if subj_grade.latest_term %}
                <p class="text-muted small mb-0">Latest: {{ subj_grade.latest_term }}</p>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="col-12">
          <div class="alert alert-secondary">
            No subjects found for this student.
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Detailed Grade Records -->
    <div class="card card-custom">
      <h4 class="text-primary mb-3">Grade Details</h4>

      {% if detailed_grades %}
        <div style="max-height: 600px; overflow-y: auto;">
          {% for grade_detail in detailed_grades %}
            <div class="p-4 mb-3 rounded border {% if grade_detail.percentage < 75 %}border-danger-subtle bg-danger bg-opacity-10{% else %}border-secondary-subtle{% endif %}">
              <!-- Title + Grade -->
              <div class="d-flex justify-content-between mb-2">
                <h5 class="text-primary mb-0">{{ grade_detail.assessment.name }}</h5>
                <span class="badge {% if grade_detail.percentage >= 90 %}bg-success{% elif grade_detail.percentage >= 75 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                  {{ grade_detail.score }}/{{ grade_detail.max_score }} ({{ grade_detail.percentage }}%)
                </span>
              </div>

              <!-- Metadata -->
              <div class="text-muted small mb-3 d-flex gap-3 flex-wrap">
                <span>{{ grade_detail.subject.name }}</span>
                <span>•</span>
                <span>{{ grade_detail.category }}</span>
                <span>•</span>
                <span>{{ grade_detail.date|date:"Y-m-d" }}</span>
                <span>•</span>
                <span>{{ grade_detail.term }}</span>
                <span>•</span>
                <span class="text-primary">{{ grade_detail.teacher_name }}</span>
              </div>

              {% if grade_detail.percentage < 75 %}
                <!-- Low grade warning -->
                <div class="mt-3 text-danger small d-flex align-items-center gap-2">
                  <i class="bi bi-exclamation-circle"></i>
                  <span>Low grade – consider reaching out to {{ grade_detail.teacher_name }}</span>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="alert alert-secondary mb-0">
          No detailed grade records found for this student.
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Check if child_id is in URL, if not, check sessionStorage and redirect
    var urlParams = new URLSearchParams(window.location.search);
    var childIdFromUrl = urlParams.get('child_id');
    
    if (!childIdFromUrl) {
      var storedChildId = sessionStorage.getItem('selectedChildId');
      if (storedChildId) {
        var currentUrl = window.location.href.split('?')[0];
        window.location.href = currentUrl + '?child_id=' + storedChildId;
        return;
      }
    } else {
      // Store the child_id from URL to sessionStorage
      sessionStorage.setItem('selectedChildId', childIdFromUrl);
    }

    // Set progress bar widths from data attributes
    document.querySelectorAll('.progress-bar[data-width]').forEach(function (bar) {
      var width = parseFloat(bar.getAttribute('data-width'));
      if (!isNaN(width)) {
        bar.style.width = width + '%';
      }
    });

    // Handle child selector change
    var childSelector = document.getElementById('childSelector');
    if (childSelector) {
      childSelector.addEventListener('change', function () {
        var childId = this.value;
        sessionStorage.setItem('selectedChildId', childId);
        var currentUrl = window.location.href.split('?')[0];
        window.location.href = currentUrl + '?child_id=' + childId;
      });
    }
  });
</script>
{% endblock %}
