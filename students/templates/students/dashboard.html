{% extends 'base.html' %}
{% load static %}

{% block title %}Student Dashboard - EduLog{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="dashboard-container container py-4">
    <div class="container my-4">
        <!-- Header -->
        <div class="mb-4">
            <h2 class="text-primary mb-2">Dashboard</h2>
            <p class="text-muted">Overview of your academic performance and progress</p>
        </div>

        <!-- Quick Stats -->
        <div class="row g-4">
          
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card p-4 rounded-3 border">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-muted small mb-1">Overall GPA</p>
                  <p class="text-primary fw-bold mb-2">{{ gpa|default:"0.0" }}</p>
                  <span class="badge {{ gpa_badge_class|default:'bg-info-subtle text-info' }}">{{ gpa_badge|default:"N/A" }}</span>
                </div>
                <div class="bg-warning-subtle p-3 rounded d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                  <i class="bi bi-award text-warning fs-4"></i>
                </div>
              </div>
            </div>
          </div>
      
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card p-4 rounded-3 border">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-muted small mb-1">Attendance Rate</p>
                  <p class="text-primary fw-bold mb-2">{{ attendance_percentage|default:"0" }}%</p>
                  <span class="badge {{ attendance_badge_class|default:'bg-info-subtle text-info' }}">{{ attendance_badge|default:"N/A" }}</span>
                </div>
                <div class="bg-success-subtle p-3 rounded d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                  <i class="bi bi-check-circle text-success fs-4"></i>
                </div>
              </div>
            </div>
          </div>
      
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card p-4 rounded-3 border">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-muted small mb-1">Average Grade</p>
                  <p class="text-primary fw-bold mb-2">{{ average_grade|default:"0" }}%</p>
                  <span class="badge {{ grade_badge_class|default:'bg-info-subtle text-info' }}">{{ grade_badge|default:"N/A" }}</span>
                </div>
                <div class="bg-info-subtle p-3 rounded d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                  <i class="bi bi-graph-up text-info fs-4"></i>
                </div>
              </div>
            </div>
          </div>
      
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card p-4 rounded-3 border">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-muted small mb-1">Alerts</p>
                  <p class="text-primary fw-bold mb-2">{{ alerts_count|default:"0" }}</p>
                  <span class="badge {{ alerts_badge_class|default:'bg-info-subtle text-info' }}">{{ alerts_badge|default:"All clear" }}</span>
                </div>
                <div class="bg-danger-subtle p-3 rounded d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                  <i class="bi bi-exclamation-circle text-danger fs-4"></i>
                </div>
              </div>
            </div>
          </div>
      
        </div>
      
        <!-- Charts -->
        <div class="row g-4 mt-2">
      
          <div class="col-lg-6">
            <div class="card p-4 rounded-3 border">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h5 class="text-primary mb-1">Attendance Trend</h5>
                  <p class="text-muted small">Monthly attendance percentage</p>
                </div>
                <i class="bi bi-calendar text-muted"></i>
              </div>
      
              <canvas id="attendanceTrendChart" height="200"></canvas>
      
            </div>
          </div>
      
          <div class="col-lg-6">
            <div class="card p-4 rounded-3 border">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h5 class="text-primary mb-1">Grade Progress</h5>
                  <p class="text-muted small">Current vs previous term</p>
                </div>
                <i class="bi bi-arrow-up text-muted"></i>
              </div>
      
              <canvas id="gradeProgressChart" height="200"></canvas>
      
            </div>
          </div>
      
        </div>
      
        <!-- Performance and Skills -->
        <div class="row g-4 mt-2">
      
          <div class="col-lg-4">
            <div class="card p-4 rounded-3 border">
              <h5 class="text-primary mb-1">Performance Distribution</h5>
              <p class="text-muted small mb-3">Grade breakdown by range</p>
      
              <canvas id="performanceDistributionChart" height="200"></canvas>
      
              <!-- Legend -->
              <div class="mt-4">
                <div class="d-flex justify-content-between small mb-2">
                  <div class="d-flex align-items-center gap-2">
                    <span class="rounded-circle d-inline-block" style="width:10px;height:10px;background:#4caf50;"></span>
                    <span class="text-muted">Excellent (90-100)</span>
                  </div>
                  <span class="text-primary fw-bold">{{ excellent_count|default:"0" }}</span>
                </div>
      
                <div class="d-flex justify-content-between small mb-2">
                  <div class="d-flex align-items-center gap-2">
                    <span class="rounded-circle d-inline-block" style="width:10px;height:10px;background:#2196f3;"></span>
                    <span class="text-muted">Good (80-89)</span>
                  </div>
                  <span class="text-primary fw-bold">{{ good_count|default:"0" }}</span>
                </div>
      
                <div class="d-flex justify-content-between small mb-2">
                  <div class="d-flex align-items-center gap-2">
                    <span class="rounded-circle d-inline-block" style="width:10px;height:10px;background:#ff9800;"></span>
                    <span class="text-muted">Average (70-79)</span>
                  </div>
                  <span class="text-primary fw-bold">{{ average_count|default:"0" }}</span>
                </div>
      
                <div class="d-flex justify-content-between small">
                  <div class="d-flex align-items-center gap-2">
                    <span class="rounded-circle d-inline-block" style="width:10px;height:10px;background:#f44336;"></span>
                    <span class="text-muted">Needs Improvement (<70)</span>
                  </div>
                  <span class="text-primary fw-bold">{{ needs_improvement_count|default:"0" }}</span>
                </div>
      
              </div>
      
            </div>
          </div>
      
          <div class="col-lg-8">
            <div class="card p-4 rounded-3 border">
      
              <h5 class="text-primary mb-1">Skills Overview</h5>
              <p class="text-muted small mb-3">Performance by subject</p>
      
              <div class="row">
      
                <div class="col-md-6">
                  <canvas id="subjectPerformanceChart" height="250"></canvas>
                </div>
      
                <div class="col-md-6 d-flex flex-column justify-content-center">
      
                  <div class="mb-3">
                    <div class="d-flex justify-content-between small mb-1">
                      <span class="text-muted">Overall Progress</span>
                      <span class="text-primary fw-bold">{{ average_grade|default:"0" }}%</span>
                    </div>
                    <div class="progress" style="height:5px;">
                      <div class="progress-bar" role="progressbar" data-progress="{{ average_grade|default:0 }}"></div>
                    </div>
                  </div>
      
                  <div class="d-flex align-items-center small mb-3">
                    <i class="bi bi-bullseye text-success me-2"></i>
                    <span class="text-muted">
                      {% if average_grade >= 90 %}
                        Excellent performance! Keep up the great work.
                      {% elif average_grade >= 80 %}
                        On track to meet semester goals
                      {% elif average_grade >= 70 %}
                        Making progress towards your goals
                      {% else %}
                        Focus on improving your grades
                      {% endif %}
                    </span>
                  </div>
      
                  <div class="p-3 bg-success-subtle rounded border border-success">
                    <p class="small text-success mb-0">
                      {% if total_subjects_with_grades > 0 %}
                        You have grades recorded for {{ total_subjects_with_grades }} subject{{ total_subjects_with_grades|pluralize }}.
                      {% else %}
                        No grades recorded yet. Check back after your first assessments.
                      {% endif %}
                    </p>
                  </div>
      
                </div>
      
              </div>
      
            </div>
          </div>
      
        </div>
      
      </div>
      
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

{{ attendance_trend_data|json_script:"attendance-trend-data" }}
{{ grade_progress_by_subject|json_script:"grade-progress-data" }}
{{ subject_performance_data|json_script:"subject-performance-data" }}
{{ subject_labels|json_script:"subject-labels-data" }}
{{ performance_distribution|json_script:"performance-distribution-data" }}

<script>
// Set progress bar width from data attribute
document.addEventListener('DOMContentLoaded', function() {
    const progressBar = document.querySelector('.progress-bar[data-progress]');
    if (progressBar) {
        const progress = progressBar.getAttribute('data-progress');
        progressBar.style.width = progress + '%';
    }
});

// Chart data from Django template (using json_script to avoid linter errors)
const attendanceTrendData = JSON.parse(document.getElementById('attendance-trend-data').textContent);
const gradeProgressData = JSON.parse(document.getElementById('grade-progress-data').textContent);
const performanceDistribution = JSON.parse(document.getElementById('performance-distribution-data').textContent);
const subjectPerformanceData = JSON.parse(document.getElementById('subject-performance-data').textContent);
const subjectLabels = JSON.parse(document.getElementById('subject-labels-data').textContent);

// Initialize Attendance Trend Chart
const attendanceTrendCtx = document.getElementById('attendanceTrendChart');
if (attendanceTrendCtx && attendanceTrendData && attendanceTrendData.length > 0) {
    new Chart(attendanceTrendCtx, {
        type: 'line',
        data: {
            labels: attendanceTrendData.map(t => t.month),
            datasets: [{
                label: 'Attendance Rate (%)',
                data: attendanceTrendData.map(t => t.rate),
                borderColor: 'rgba(59, 130, 246, 1)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true,
                borderWidth: 3,
                pointRadius: 4,
                pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 25
                    }
                }
            },
            plugins: {
                legend: {
                    display: false  // Hide legend for cleaner look
                }
            }
        }
    });
}

// Initialize Grade Progress Chart (Current vs Previous Term)
const gradeProgressCtx = document.getElementById('gradeProgressChart');
if (gradeProgressCtx && gradeProgressData && gradeProgressData.length > 0) {
    const subjects = gradeProgressData.map(p => p.subject);
    const current = gradeProgressData.map(p => p.current);
    const previous = gradeProgressData.map(p => p.previous);
    new Chart(gradeProgressCtx, {
        type: 'bar',
        data: {
            labels: subjects,
            datasets: [
                {
                    label: 'Current Term',
                    data: current,
                    backgroundColor: 'rgba(34, 197, 94, 0.8)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 2
                },
                {
                    label: 'Previous Term',
                    data: previous,
                    backgroundColor: 'rgba(156, 163, 175, 0.8)',
                    borderColor: 'rgba(156, 163, 175, 1)',
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 25
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

// Initialize Performance Distribution Chart (Donut Chart)
const performanceDistCtx = document.getElementById('performanceDistributionChart');
if (performanceDistCtx) {
    new Chart(performanceDistCtx, {
        type: 'doughnut',
        data: {
            labels: ['Excellent (90-100)', 'Good (80-89)', 'Average (70-79)', 'Needs Improvement (<70)'],
            datasets: [{
                data: [
                    performanceDistribution.excellent,
                    performanceDistribution.good,
                    performanceDistribution.average,
                    performanceDistribution.needsImprovement
                ],
                backgroundColor: [
                    'rgba(34, 197, 94, 0.8)',
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(251, 191, 36, 0.8)',
                    'rgba(239, 68, 68, 0.8)'
                ],
                borderColor: [
                    'rgba(34, 197, 94, 1)',
                    'rgba(59, 130, 246, 1)',
                    'rgba(251, 191, 36, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '60%',  // Makes it a donut chart
            plugins: {
                legend: {
                    display: false  // Hide legend since we have custom legend below
                }
            }
        }
    });
}

// Initialize Subject Performance Chart (Radar)
const subjectPerfCtx = document.getElementById('subjectPerformanceChart');
if (subjectPerfCtx && subjectLabels.length > 0 && subjectPerformanceData.length > 0) {
    new Chart(subjectPerfCtx, {
        type: 'radar',
        data: {
            labels: subjectLabels,
            datasets: [{
                label: 'Average Grade (%)',
                data: subjectPerformanceData,
                borderColor: 'rgba(59, 130, 246, 1)',
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(59, 130, 246, 1)',
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 25,
                        display: true
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    pointLabels: {
                        font: {
                            size: 11
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false  // Hide legend for cleaner look
                }
            }
        }
    });
}
</script>

{% endblock %}

