{% extends 'base.html' %}
{% load static %}

{% block title %}Student Dashboard - EduLog{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="dashboard-container container py-4">
    <div class="container my-4">
        <!-- Header -->
        <div class="mb-4">
            <h2 class="text-primary mb-2">Dashboard</h2>
            <p class="text-muted">Overview of your academic performance and progress</p>
        </div>

        <!-- Quick Stats -->
        <div class="row g-4">
          
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card p-4 rounded-3 border">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-muted small mb-1">Overall GWA</p>
                  <p class="text-primary fw-bold mb-2">{{ gwa|default:"5.0" }}</p>
                  <span class="badge {{ gwa_badge_class|default:'bg-info-subtle text-info' }}">{{ gwa_badge|default:"N/A" }}</span>
                </div>
                <div class="bg-warning-subtle p-3 rounded d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                  <i class="bi bi-award text-warning fs-4"></i>
                </div>
              </div>
            </div>
          </div>
      
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card p-4 rounded-3 border">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-muted small mb-1">Attendance Rate</p>
                  <p class="text-primary fw-bold mb-2">{{ attendance_percentage|default:"0" }}%</p>
                  <span class="badge {{ attendance_badge_class|default:'bg-info-subtle text-info' }}">{{ attendance_badge|default:"N/A" }}</span>
                </div>
                <div class="bg-success-subtle p-3 rounded d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                  <i class="bi bi-check-circle text-success fs-4"></i>
                </div>
              </div>
            </div>
          </div>
      
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card p-4 rounded-3 border">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-muted small mb-1">Average Grade</p>
                  <p class="text-primary fw-bold mb-2">{{ average_grade|default:"0" }}%</p>
                  <span class="badge {{ grade_badge_class|default:'bg-info-subtle text-info' }}">{{ grade_badge|default:"N/A" }}</span>
                </div>
                <div class="bg-info-subtle p-3 rounded d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                  <i class="bi bi-graph-up text-info fs-4"></i>
                </div>
              </div>
            </div>
          </div>
      
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card p-4 rounded-3 border">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-muted small mb-1">Alerts</p>
                  <p class="text-primary fw-bold mb-2">{{ alerts_count|default:"0" }}</p>
                  <span class="badge {{ alerts_badge_class|default:'bg-info-subtle text-info' }}">{{ alerts_badge|default:"All clear" }}</span>
                </div>
                <div class="bg-danger-subtle p-3 rounded d-flex align-items-center justify-content-center" style="width: 56px; height: 56px;">
                  <i class="bi bi-exclamation-circle text-danger fs-4"></i>
                </div>
              </div>
            </div>
          </div>
      
        </div>
      
        <!-- Charts -->
        <div class="row g-4 mt-2">
      
          <div class="col-lg-6">
            <div class="card p-4 rounded-3 border">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h5 class="text-primary mb-1">Attendance Trend</h5>
                  <p class="text-muted small">Monthly attendance percentage</p>
                </div>
                <i class="bi bi-calendar text-muted"></i>
              </div>
      
              <canvas id="attendanceTrendChart" height="200"></canvas>
      
            </div>
          </div>
      
          <div class="col-lg-6">
            <div class="card p-4 rounded-3 border">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <h5 class="text-primary mb-1">Grade Progress</h5>
                  <p class="text-muted small">Current vs previous term</p>
                </div>
                <i class="bi bi-arrow-up text-muted"></i>
              </div>
      
              <div style="position: relative; height: 200px;">
                <canvas id="gradeProgressChart"></canvas>
              </div>
      
            </div>
          </div>
      
        </div>
      
        <!-- Performance and Skills -->
        <div class="row g-4 mt-2">
      
          <div class="col-lg-4">
            <div class="card p-4 rounded-3 border">
              <h5 class="text-primary mb-1">Performance Distribution</h5>
              <p class="text-muted small mb-3">Grade breakdown by range</p>
      
              <div style="position: relative; height: 200px;">
                <canvas id="performanceDistributionChart"></canvas>
              </div>
      
              <!-- Legend -->
              <div class="mt-4">
                <div class="d-flex justify-content-between small mb-2">
                  <div class="d-flex align-items-center gap-2">
                    <span class="rounded-circle d-inline-block" style="width:10px;height:10px;background:#4caf50;"></span>
                    <span class="text-muted">Excellent (90-100)</span>
                  </div>
                  <span class="text-primary fw-bold">{{ excellent_count|default:"0" }}</span>
                </div>
      
                <div class="d-flex justify-content-between small mb-2">
                  <div class="d-flex align-items-center gap-2">
                    <span class="rounded-circle d-inline-block" style="width:10px;height:10px;background:#2196f3;"></span>
                    <span class="text-muted">Good (80-89)</span>
                  </div>
                  <span class="text-primary fw-bold">{{ good_count|default:"0" }}</span>
                </div>
      
                <div class="d-flex justify-content-between small mb-2">
                  <div class="d-flex align-items-center gap-2">
                    <span class="rounded-circle d-inline-block" style="width:10px;height:10px;background:#ff9800;"></span>
                    <span class="text-muted">Average (70-79)</span>
                  </div>
                  <span class="text-primary fw-bold">{{ average_count|default:"0" }}</span>
                </div>
      
                <div class="d-flex justify-content-between small">
                  <div class="d-flex align-items-center gap-2">
                    <span class="rounded-circle d-inline-block" style="width:10px;height:10px;background:#f44336;"></span>
                    <span class="text-muted">Needs Improvement (<70)</span>
                  </div>
                  <span class="text-primary fw-bold">{{ needs_improvement_count|default:"0" }}</span>
                </div>
      
              </div>
      
            </div>
          </div>
      
          <div class="col-lg-8">
            <div class="card p-4 rounded-3 border">
      
              <h5 class="text-primary mb-1">Skills Overview</h5>
              <p class="text-muted small mb-3">Performance by subject</p>
      
              <div class="row">
      
                <div class="col-md-6" style="min-height: 250px; position: relative;">
                  <canvas id="subjectPerformanceChart" style="max-height: 250px;"></canvas>
                </div>
      
                <div class="col-md-6 d-flex flex-column justify-content-center">
      
                  <div class="mb-3">
                    <div class="d-flex justify-content-between small mb-1">
                      <span class="text-muted">Overall Progress</span>
                      <span class="text-primary fw-bold">{{ average_grade|default:"0" }}%</span>
                    </div>
                    <div class="progress" style="height:5px;">
                      <div class="progress-bar" role="progressbar" data-progress="{{ average_grade|default:0 }}"></div>
                    </div>
                  </div>
      
                  <div class="d-flex align-items-center small mb-3">
                    <i class="bi bi-bullseye text-success me-2"></i>
                    <span class="text-muted">
                      {% if average_grade >= 90 %}
                        Excellent performance! Keep up the great work.
                      {% elif average_grade >= 80 %}
                        On track to meet semester goals
                      {% elif average_grade >= 70 %}
                        Making progress towards your goals
                      {% else %}
                        Focus on improving your grades
                      {% endif %}
                    </span>
                  </div>
      
                  <div class="p-3 bg-success-subtle rounded border border-success">
                    <p class="small text-success mb-0">
                      {% if total_subjects_with_grades > 0 %}
                        You have grades recorded for {{ total_subjects_with_grades }} subject{{ total_subjects_with_grades|pluralize }}.
                      {% else %}
                        No grades recorded yet. Check back after your first assessments.
                      {% endif %}
                    </p>
                  </div>
      
                </div>
      
              </div>
      
            </div>
          </div>
      
        </div>
      
      </div>
      
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

{{ attendance_trend_data|json_script:"attendance-trend-data" }}
{{ grade_progress_by_subject|json_script:"grade-progress-data" }}
{{ subject_performance_data|json_script:"subject-performance-data" }}
{{ subject_labels|json_script:"subject-labels-data" }}
{{ performance_distribution|json_script:"performance-distribution-data" }}

<script>
// Set progress bar width from data attribute
document.addEventListener('DOMContentLoaded', function() {
    const progressBar = document.querySelector('.progress-bar[data-progress]');
    if (progressBar) {
        const progress = progressBar.getAttribute('data-progress');
        progressBar.style.width = progress + '%';
    }
});

// Function to safely get JSON data
function getJsonData(elementId, defaultValue) {
    try {
        const el = document.getElementById(elementId);
        return el ? JSON.parse(el.textContent) : defaultValue;
    } catch (e) {
        console.error('Error parsing JSON for', elementId, e);
        return defaultValue;
    }
}

// Wait for both Chart.js and DOM to be ready
function waitForChartJS(callback, maxAttempts = 50) {
    let attempts = 0;
    const checkChart = setInterval(function() {
        attempts++;
        if (typeof Chart !== 'undefined') {
            clearInterval(checkChart);
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', callback);
            } else {
                callback();
            }
        } else if (attempts >= maxAttempts) {
            clearInterval(checkChart);
            console.error('Chart.js failed to load after', maxAttempts, 'attempts');
        }
    }, 100);
}

// Initialize all charts
function initializeAllCharts() {
    console.log('=== Starting Chart Initialization ===');
    console.log('Chart.js available:', typeof Chart !== 'undefined');
    console.log('DOM ready:', document.readyState);

    // Get data
    const attendanceTrendData = getJsonData('attendance-trend-data', []);
    const gradeProgressData = getJsonData('grade-progress-data', []);
    const performanceDistribution = getJsonData('performance-distribution-data', {excellent: 0, good: 0, average: 0, needsImprovement: 0});
    const subjectPerformanceData = getJsonData('subject-performance-data', []);
    const subjectLabels = getJsonData('subject-labels-data', []);

    console.log('=== Chart Data ===');
    console.log('Grade Progress:', gradeProgressData);
    console.log('Performance Distribution:', performanceDistribution);
    console.log('Subject Performance Data:', subjectPerformanceData);
    console.log('Subject Labels:', subjectLabels);
    console.log('Attendance Trend:', attendanceTrendData);

    // Check canvas elements
    const gradeCtx = document.getElementById('gradeProgressChart');
    const perfCtx = document.getElementById('performanceDistributionChart');
    const subjectCtx = document.getElementById('subjectPerformanceChart');
    
    console.log('=== Canvas Elements ===');
    console.log('Grade Progress Canvas:', !!gradeCtx);
    console.log('Performance Distribution Canvas:', !!perfCtx);
    console.log('Subject Performance Canvas:', !!subjectCtx);

    // Initialize Grade Progress Chart
    try {
        if (gradeCtx) {
            if (gradeProgressData && gradeProgressData.length > 0) {
                const subjects = gradeProgressData.map(p => p.subject || '');
                const current = gradeProgressData.map(p => parseFloat(p.current) || 0);
                const previous = gradeProgressData.map(p => parseFloat(p.previous) || 0);
                const chart = new Chart(gradeCtx, {
                    type: 'bar',
                    data: {
                        labels: subjects,
                        datasets: [{
                            label: 'Current Term',
                            data: current,
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 2
                        }, {
                            label: 'Previous Term',
                            data: previous,
                            backgroundColor: 'rgba(156, 163, 175, 0.8)',
                            borderColor: 'rgba(156, 163, 175, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100, ticks: { stepSize: 25 } }
                        },
                        plugins: { legend: { display: true, position: 'top' } }
                    }
                });
                console.log('Grade Progress Chart initialized successfully', chart);
            } else {
                console.log('Grade Progress Chart: No data available');
                if (gradeCtx && gradeCtx.parentElement) {
                    gradeCtx.style.display = 'none';
                    gradeCtx.parentElement.innerHTML = '<p class="text-muted text-center py-4">No grade progress data available</p>';
                }
            }
        } else {
            console.warn('Grade Progress Chart: Canvas element not found');
        }
    } catch (e) {
        console.error('Error initializing Grade Progress Chart:', e);
        console.error('Error details:', e.message, e.stack);
    }

    // Initialize Performance Distribution Chart
    try {
        if (perfCtx) {
            const total = (performanceDistribution.excellent || 0) + 
                         (performanceDistribution.good || 0) + 
                         (performanceDistribution.average || 0) + 
                         (performanceDistribution.needsImprovement || 0);
            
            // Ensure parent container has height
            const parent = perfCtx.parentElement;
            if (parent) {
                parent.style.height = '200px';
                parent.style.position = 'relative';
            }
            
            // Always render the chart, even if total is 0 (shows empty state)
            const chart = new Chart(perfCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Excellent (90-100)', 'Good (80-89)', 'Average (70-79)', 'Needs Improvement (<70)'],
                    datasets: [{
                        data: [
                            performanceDistribution.excellent || 0,
                            performanceDistribution.good || 0,
                            performanceDistribution.average || 0,
                            performanceDistribution.needsImprovement || 0
                        ],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(251, 191, 36, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgba(34, 197, 94, 1)',
                            'rgba(59, 130, 246, 1)',
                            'rgba(251, 191, 36, 1)',
                            'rgba(239, 68, 68, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    return label + ': ' + value + ' subject' + (value !== 1 ? 's' : '');
                                }
                            }
                        }
                    }
                }
            });
            console.log('Performance Distribution Chart initialized', chart);
            console.log('Performance Distribution data:', performanceDistribution);
            chart.update();
        } else {
            console.warn('Performance Distribution Chart: Canvas element not found');
        }
    } catch (e) {
        console.error('Error initializing Performance Distribution Chart:', e);
        console.error('Error details:', e.message, e.stack);
    }

    // Initialize Subject Performance Chart
    try {
        if (subjectCtx) {
            // Render chart even if all values are 0 (so user can see the structure)
            if (subjectLabels && subjectLabels.length > 0 && subjectPerformanceData && subjectPerformanceData.length > 0) {
                // Ensure canvas has explicit dimensions and is visible
                subjectCtx.style.display = 'block';
                subjectCtx.style.width = '100%';
                subjectCtx.style.height = '250px';
                
                // Get parent container and ensure it has dimensions
                const parentContainer = subjectCtx.parentElement;
                if (parentContainer) {
                    parentContainer.style.minHeight = '250px';
                }
                
                const chartData = subjectPerformanceData.map(d => {
                    const val = parseFloat(d) || 0;
                    console.log('Mapping subject performance data:', d, '->', val);
                    // Use actual value, even if 0 (chart will show at center)
                    return val;
                });
                
                console.log('Creating radar chart with:', {
                    labels: subjectLabels,
                    data: chartData,
                    originalData: subjectPerformanceData
                });
                
                const chart = new Chart(subjectCtx, {
                    type: 'radar',
                    data: {
                        labels: subjectLabels,
                        datasets: [{
                            label: 'Average Grade (%)',
                            data: chartData,
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        aspectRatio: 1,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                min: 0,
                                ticks: { 
                                    stepSize: 25, 
                                    display: true,
                                    font: { size: 10 }
                                },
                                grid: { 
                                    color: 'rgba(0, 0, 0, 0.1)',
                                    lineWidth: 1
                                },
                                pointLabels: { 
                                    font: { size: 11 },
                                    padding: 10
                                }
                            }
                        },
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                enabled: true,
                                callbacks: {
                                    label: function(context) {
                                        const val = context.parsed.r;
                                        // If value is 1 and original was 0, show "No grade"
                                        const originalVal = subjectPerformanceData[context.dataIndex];
                                        if (originalVal === 0 && val === 1) {
                                            return 'No grade recorded yet';
                                        }
                                        return 'Grade: ' + val + '%';
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('Subject Performance Chart created:', chart);
                
                // Force update and resize
                setTimeout(() => {
                    chart.update();
                    chart.resize();
                }, 100);
            } else {
                console.log('Subject Performance Chart: No valid data available', {
                    hasLabels: !!subjectLabels && subjectLabels.length > 0,
                    hasData: !!subjectPerformanceData && subjectPerformanceData.length > 0,
                    hasValidData: hasValidData
                });
                if (subjectCtx && subjectCtx.parentElement) {
                    subjectCtx.style.display = 'none';
                    subjectCtx.parentElement.innerHTML = '<p class="text-muted text-center py-4">No subject performance data available</p>';
                }
            }
        } else {
            console.warn('Subject Performance Chart: Canvas element not found');
        }
    } catch (e) {
        console.error('Error initializing Subject Performance Chart:', e);
        console.error('Error details:', e.message, e.stack);
    }

    // Initialize Attendance Trend Chart
    try {
        const attendanceCtx = document.getElementById('attendanceTrendChart');
        if (attendanceCtx && attendanceTrendData && attendanceTrendData.length > 0) {
            new Chart(attendanceCtx, {
                type: 'line',
                data: {
                    labels: attendanceTrendData.map(t => t.month || ''),
                    datasets: [{
                        label: 'Attendance Rate (%)',
                        data: attendanceTrendData.map(t => parseFloat(t.rate) || 0),
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { stepSize: 25 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
            console.log('Attendance Trend Chart initialized');
        }
    } catch (e) {
        console.error('Error initializing Attendance Trend Chart:', e);
    }

    console.log('All charts initialization complete');
    
    // Force chart resize/update after a short delay to ensure DOM is fully ready
    setTimeout(function() {
        console.log('Forcing chart resize...');
        if (typeof Chart !== 'undefined' && Chart.helpers) {
            Chart.helpers.each(Chart.instances, function(instance) {
                instance.resize();
            });
        }
        window.dispatchEvent(new Event('resize'));
    }, 500);
}

// Start initialization process
waitForChartJS(initializeAllCharts);
</script>

{% endblock %}

