{% extends "base.html" %}
{% load static %}
{% block title %}Grades | EduLog{% endblock %}
{% block content %}

<style>
    body {
        background: #f5f7fa;
    }

    .card {
        border-radius: 16px;
    }

    .card.rounded-3 {
        border-radius: 1rem !important;
    }

    .progress-bar {
        background-color: #3b82f6;
    }
</style>

<div class="dashboard-container py-4">
    <div class="mb-4">
        <h2 class="text-primary">My Grades</h2>
        <p class="text-muted small">View detailed grades and teacher feedback</p>
    </div>

    <!-- Grade Summary by Subject -->
    <div class="row g-3 mb-4" id="grade-summary-row">
        <!-- cards injected by JS -->
    </div>

    <!-- Detailed Grade Records -->
    <div class="card card-round border-light shadow-sm p-4">
        <h3 class="text-primary mb-4">Grade Details with Remarks</h3>

        <div class="scroll-area" id="grade-records">
            <!-- grade records injected by JS -->
        </div>
    </div>
</div>

{{ subject_summary|json_script:"subject-summary-data" }}
{{ detailed_grade_records|json_script:"detailed-grade-records-data" }}

<script>
    // Data from Django database
    const subjects = JSON.parse(document.getElementById('subject-summary-data').textContent || '[]');
    const gradeRecords = JSON.parse(document.getElementById('detailed-grade-records-data').textContent || '[]');

        // Utility: determine badge class by numeric grade
        function badgeClassForGrade(grade) {
      if (grade >= 90) return 'bg-success text-white';
      if (grade >= 80) return 'bg-primary text-white';
      if (grade >= 70) return 'bg-warning text-dark';
        return 'bg-danger text-white';
    }

        // Render the first 3 subjects (like subjects.slice(0, 3))
        (function renderSubjects() {
      const container = document.getElementById('grade-summary-row');
        const slice = subjects.slice(0, 3);
      slice.forEach(subject => {
        const col = document.createElement('div');
        col.className = 'col-12 col-md-4';

        const card = document.createElement('div');
        card.className = 'card card-round p-3 h-100 border-light shadow-sm';

        // header row
        const header = document.createElement('div');
        header.className = 'd-flex align-items-center justify-content-between mb-3';
        const title = document.createElement('h5');
        title.className = 'mb-0 text-primary';
        title.textContent = subject.name;
        const badge = document.createElement('span');
        badge.className = 'badge-grade badge ' + badgeClassForGrade(subject.grade);
        badge.textContent = subject.grade + '%';

        header.appendChild(title);
        header.appendChild(badge);

        // progress
        const progressWrapper = document.createElement('div');
        progressWrapper.className = 'mb-2';
        const prog = document.createElement('div');
        prog.className = 'progress';
        prog.setAttribute('style', 'height: .5rem;');
        const bar = document.createElement('div');
        bar.className = 'progress-bar';
        bar.setAttribute('role', 'progressbar');
        bar.style.width = Math.min(100, Math.max(0, subject.grade)) + '%';
        bar.setAttribute('aria-valuenow', subject.grade);
        bar.setAttribute('aria-valuemin', 0);
        bar.setAttribute('aria-valuemax', 100);

        prog.appendChild(bar);
        progressWrapper.appendChild(prog);

        const p = document.createElement('p');
        p.className = 'text-muted small mb-0';
        p.textContent = 'Current average';

        card.appendChild(header);
        card.appendChild(progressWrapper);
        card.appendChild(p);

        col.appendChild(card);
        container.appendChild(col);
      });
    })();

        // Render gradeRecords
        (function renderRecords() {
      const container = document.getElementById('grade-records');
      gradeRecords.forEach(record => {
        const item = document.createElement('div');
        item.className = 'mb-3 p-3 rounded border';
        const percentage = record.percentage || (record.maxGrade > 0 ? (record.grade / record.maxGrade * 100) : 0);
        if (percentage < 70) {
            item.classList.add('border-danger', 'bg-light');
        } else {
            item.classList.add('border-1', 'border-light');
        }

        // top flex
        const top = document.createElement('div');
        top.className = 'd-flex w-100 justify-content-between mb-2';

        const left = document.createElement('div');
        left.className = 'flex-grow-1';

        // title + badge
        const titleRow = document.createElement('div');
        titleRow.className = 'd-flex align-items-center gap-2 mb-2';

        const title = document.createElement('h5');
        title.className = 'mb-0 text-primary';
        title.textContent = record.title;

        const badge = document.createElement('span');
        badge.className = 'badge-grade badge ' + badgeClassForGrade(percentage);
        badge.textContent = record.grade + '/' + record.maxGrade;

        titleRow.appendChild(title);
        titleRow.appendChild(badge);

        // metadata row
        const meta = document.createElement('div');
        meta.className = 'd-flex gap-2 small text-muted mb-2 align-items-center';
        const subj = document.createElement('span'); subj.textContent = record.subject;
        const dot1 = document.createElement('span'); dot1.textContent = '•';
        const type = document.createElement('span'); type.textContent = record.type;
        const dot2 = document.createElement('span'); dot2.textContent = '•';
        const date = document.createElement('span'); date.textContent = record.date;

        meta.appendChild(subj);
        meta.appendChild(dot1);
        meta.appendChild(type);
        meta.appendChild(dot2);
        meta.appendChild(date);

        left.appendChild(titleRow);
        left.appendChild(meta);

        // remarks (optional)
        if (record.remarks && record.remarks.trim().length > 0) {
          const remarksWrap = document.createElement('div');
        remarksWrap.className = 'd-flex align-items-start gap-2 mt-2 remarks-box';

        const iconOuter = document.createElement('div');
        iconOuter.className = 'bg-primary text-white rounded-circle d-flex align-items-center justify-content-center';
        iconOuter.setAttribute('style', 'width:28px;height:28px;');
        const icon = document.createElement('i');
        icon.className = 'bi bi-chat-left-text-fill';
        iconOuter.appendChild(icon);

        const remarksText = document.createElement('div');
        const label = document.createElement('p');
        label.className = 'mb-0 small text-primary';
        label.textContent = "Teacher's Remarks:";
        const message = document.createElement('p');
        message.className = 'mb-0 small text-primary fw-semibold';
        message.textContent = record.remarks;

        remarksText.appendChild(label);
        remarksText.appendChild(message);

        remarksWrap.appendChild(iconOuter);
        remarksWrap.appendChild(remarksText);

        left.appendChild(remarksWrap);
        }

        top.appendChild(left);

        item.appendChild(top);

        // needs improvement line
        if (percentage < 70) {
          const needDiv = document.createElement('div');
        needDiv.className = 'mt-3 d-flex align-items-center gap-2 small needs-improvement';

        const warnIcon = document.createElement('i');
        warnIcon.className = 'bi bi-exclamation-circle-fill';
        needDiv.appendChild(warnIcon);

        const span = document.createElement('span');
        span.textContent = 'Needs improvement - Consider speaking with your teacher';
        needDiv.appendChild(span);

        item.appendChild(needDiv);
        }

        container.appendChild(item);
      });
    })();
</script>

{% endblock %}